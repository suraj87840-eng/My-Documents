<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Student - Live Class</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
.container{max-width:1150px;margin:20px auto;display:flex;gap:20px;}
.left{width:800px;height:500px;background:#000;border-radius:10px;color:#fff;display:flex;flex-direction:column;}
.video{flex:1;display:flex;align-items:center;justify-content:center;}
.right{width:300px;height:500px;background:#fff;border-radius:10px;display:flex;flex-direction:column;}
.header{background:#1a73e8;color:#fff;padding:12px;border-radius:10px 10px 0 0;font-weight:700;text-align:center}
.chat{flex:1;padding:8px;overflow:auto}
.input{display:flex;padding:8px;border-top:1px solid #ddd}
.input input{flex:1;padding:8px;border-radius:5px;border:1px solid #ccc}
.btn{padding:8px 10px;border-radius:6px;border:none;background:#1a73e8;color:#fff;cursor:pointer;margin-left:6px}
.small{font-size:12px;color:#666;margin:6px 0}
.video video{width:100%;height:100%;object-fit:cover;border-radius:8px}
.status{padding:10px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <div style="padding:10px;font-weight:700">ðŸ”´ Live Classroom</div>
    <div class="video" id="videoArea">
      <div class="status" id="status">Waiting to join...</div>
      <div id="remoteHolder"></div>
    </div>
  </div>

  <div class="right">
    <div class="header">Student Chat</div>
    <div class="chat" id="chat"></div>
    <div class="input">
      <input id="msg" placeholder="Type message...">
      <button class="btn" onclick="sendChat()">Send</button>
    </div>
    <div style="padding:8px">
      <button class="btn" onclick="raiseHand()">âœ‹ Raise Hand</button>
      <div class="small">You will be placed in waiting until teacher accepts you.</div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let pc = null; // RTCPeerConnection for receiving teacher
let teacherId = null;

const constraints = { video: true, audio: true };

// Join as student
socket.emit('student-join');

socket.on('waiting', (d) => {
  const s = document.getElementById('status');
  if (d.reason === 'no_teacher') s.textContent = 'No teacher yet. Waiting...';
  else if (d.reason === 'full') s.textContent = 'Class is full. You are in waiting room.';
  else s.textContent = 'Request sent. Waiting for teacher approval.';
});

socket.on('accepted', (d) => {
  teacherId = d.teacherId;
  document.getElementById('status').textContent = 'Accepted! Preparing to receive stream...';
});

// Teacher will send offer
socket.on('offer', async ({ sdp, teacherId: tId }) => {
  console.log('Received offer from teacher', tId);
  teacherId = tId;
  // create peer connection
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  pc.ontrack = (ev) => {
    console.log('ontrack', ev);
    const holder = document.getElementById('remoteHolder');
    holder.innerHTML = '';
    const v = document.createElement('video');
    v.autoplay = true; v.playsInline = true;
    v.srcObject = ev.streams[0];
    holder.appendChild(v);
    document.getElementById('status').style.display = 'none';
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit('ice-candidate', { targetId: teacherId, candidate: e.candidate });
    }
  };

  try {
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('answer', { teacherId: teacherId, sdp: pc.localDescription });
    console.log('Sent answer to teacher');
  } catch (err) {
    console.error('Error handling offer', err);
  }
});

socket.on('ice-candidate', async ({ from, candidate }) => {
  try {
    if (pc && candidate) await pc.addIceCandidate(candidate);
  } catch (e) {
    console.error('addIceCandidate error', e);
  }
});

socket.on('teacher-left', () => {
  document.getElementById('status').textContent = 'Teacher left the class.';
  const holder = document.getElementById('remoteHolder');
  holder.innerHTML = '';
});

// Chat
function sendChat(){
  const m = document.getElementById('msg').value.trim();
  if(!m) return;
  socket.emit('chat', m);
  document.getElementById('msg').value = '';
}
socket.on('chat', ({ from, msg })=>{
  const c = document.getElementById('chat');
  const d = document.createElement('div');
  d.textContent = (from===teacherId? 'Teacher': from) + ': ' + msg;
  c.appendChild(d);
  c.scrollTop = c.scrollHeight;
});

// Raise hand
function raiseHand(){
  socket.emit('raise-hand');
  alert('Raised hand â€” wait for teacher to accept.');
}
</script>
</body>
</html>
